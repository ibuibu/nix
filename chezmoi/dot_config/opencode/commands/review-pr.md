---
name: review-pr
description: 現在のブランチのPRをコードレビューとセキュリティレビューの両方で並列分析
---

# PR並列レビューコマンド

現在のブランチに関連するPRに対して、以下の2つのレビューを**並列**で実行し、統合されたフィードバックを提供します。

## レビューエージェント

1. **@gh-pr-review** - 一般的なコードレビュー
   - コード品質（可読性、保守性、命名規則）
   - パフォーマンス
   - バグリスク
   - テストカバレッジ

2. **@gh-pr-security-review** - セキュリティレビュー
   - OWASP Top 10
   - 認証・認可
   - インジェクション攻撃
   - 機密情報漏洩
   - 依存パッケージの脆弱性

## 実行手順

### 1. PR情報の取得

```bash
# 現在のブランチのPR情報を取得
gh pr view --json number,url,title,body,additions,deletions,changedFiles
```

PRが存在しない場合はエラーメッセージを表示して終了。

### 2. レビューエージェントを並列起動

**重要**: 2つのエージェントを**並列**で起動します。Task toolを使用して、同時に2つのサブエージェントセッションを開始してください。

```
並列で以下を実行:
- Task 1: @gh-pr-review を起動してコードレビューを実施
- Task 2: @gh-pr-security-review を起動してセキュリティレビューを実施
```

各エージェントには以下の指示を渡す：

**@gh-pr-review への指示**:
```
現在のブランチのPR（#[PR番号]）に対してコードレビューを実施してください。

以下の観点でレビューし、レビューコメントを生成してください（投稿はしないでください）:
- コード品質（可読性、保守性、命名規則、重複）
- パフォーマンス（効率性、メモリ使用、キャッシュ）
- バグリスク（エラーハンドリング、エッジケース、型安全性）
- テストカバレッジ

レビュー結果は以下の形式で返してください：
- 指摘事項のリスト（優先度、ファイルパス、行番号、内容）
- 総評
```

**@gh-pr-security-review への指示**:
```
現在のブランチのPR（#[PR番号]）に対してセキュリティレビューを実施してください。

以下の観点でレビューし、レビューコメントを生成してください（投稿はしないでください）:
- OWASP Top 10
- 認証・認可の実装
- インジェクション攻撃のリスク
- 機密情報の露出
- 依存パッケージの脆弱性

レビュー結果は以下の形式で返してください：
- 指摘事項のリスト（重大度、ファイルパス、行番号、内容）
- セキュリティチェックリストの結果
- 総評
```

### 3. レビュー結果の統合

両方のエージェントの結果を待機し、統合します。

```
【コードレビュー結果】
[一般的なコードレビューの指摘]

【セキュリティレビュー結果】
[セキュリティレビューの指摘]

【統合評価】
- 重大な問題（Critical）: X件
- 重要な指摘（Important）: Y件
- 改善提案（Suggestion）: Z件
```

### 4. ユーザーへの確認

統合されたレビュー結果をユーザーに提示し、次のアクションを選択させる：

```
レビュー結果を統合しました。次のアクションを選択してください：

1. GitHubにレビューコメントを投稿（全ての指摘）
2. 一部の指摘のみを選択して投稿
3. レビュー内容を編集してから投稿
4. 投稿せずに結果を表示のみ
5. Approve（問題なし）
6. Request Changes（修正が必要）
```

### 5. 選択されたアクションを実行

#### オプション1: 全ての指摘を投稿

```bash
# レビューコメントを投稿
gh pr review --comment -b "[統合レビュー結果]"

# 個別のファイル・行にコメント
gh pr review --comment \
  --body "[指摘内容]" \
  --path "[ファイルパス]" \
  --line [行番号]
```

#### オプション2: 一部の指摘を選択

ユーザーに指摘番号を選択させ（例: `1,3,5`）、選択された指摘のみを投稿。

#### オプション3: 編集してから投稿

レビューコメントをテキストエディタで編集できるようにする。

#### オプション4: 表示のみ

レビュー結果をターミナルに表示して終了。

#### オプション5: Approve

```bash
gh pr review --approve -b "LGTM! 両方のレビュー（コード品質・セキュリティ）で問題ありませんでした。👍"
```

#### オプション6: Request Changes

```bash
gh pr review --request-changes -b "[統合レビュー結果]

以下の修正が必要です：
[Critical/Important な指摘のリスト]"
```

## レビュー結果の形式

### コードレビューコメント例

```markdown
## 📝 コードレビュー

### 🚨 Critical
1. `src/auth.ts:45` - パスワードが平文で保存されています
   - ハッシュ化（bcrypt等）を使用してください

### ⚠️ Important
2. `src/api/users.ts:120` - エラーハンドリングが不足
   - try-catch で適切に処理してください

### 💡 Suggestion
3. `src/utils/format.ts:30` - より効率的な実装が可能
   - `map().filter()` より `reduce()` の方が効率的です
```

### セキュリティレビューコメント例

```markdown
## 🔒 セキュリティレビュー

### 🚨 Critical Security Issues
1. `src/db/query.ts:67` - SQLインジェクションの脆弱性
   - パラメータ化クエリを使用してください

### ⚠️ Security Concerns
2. `package.json` - 既知の脆弱性があるパッケージ
   - `lodash` を最新版にアップデートしてください

### ✅ セキュリティチェックリスト
- [x] 入力値のバリデーション
- [x] XSS対策
- [ ] CSRF対策（要対応）
- [ ] 機密情報のハードコーディング（要確認）
```

## オプション機能

### ドライランモード

```bash
# レビュー結果を表示するだけで投稿しない
/review-pr --dry-run
```

### 特定の観点のみレビュー

```bash
# セキュリティレビューのみ
/review-pr --security-only

# コードレビューのみ
/review-pr --code-only
```

### レビューの詳細度

```bash
# 簡易レビュー（Critical/Importantのみ）
/review-pr --brief

# 詳細レビュー（全ての観点）
/review-pr --detailed
```

## 注意事項

- **並列実行**: 2つのエージェントは必ず並列で実行してください（順次実行しないでください）
- **重複排除**: 両方のエージェントが同じ問題を指摘した場合は、重複を排除してください
- **優先度の統一**: セキュリティの Critical は コードレビューの Critical より優先度が高いです
- **建設的なフィードバック**: 批判ではなく改善提案を心がけてください
- **コンテキストの理解**: PRの背景や制約を理解した上でレビューしてください

## Definition of Done

- [ ] 現在のブランチのPRを正常に取得
- [ ] @gh-pr-review と @gh-pr-security-review を並列起動
- [ ] 両方のレビュー結果を取得
- [ ] レビュー結果を統合して表示
- [ ] ユーザーの選択に応じたアクションを実行
- [ ] レビューコメントがGitHubに投稿された（投稿を選択した場合）
